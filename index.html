<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>SkyStrike：3D 槍戰</title>
<style>
body{margin:0;overflow:hidden;font-family:Arial;}
#menu{
    position:fixed;inset:0;
    display:flex;flex-direction:column;
    justify-content:center;align-items:center;
    color:white;background:rgba(0,0,0,0.45);z-index:10;
}
button{padding:14px 36px;font-size:20px;margin:8px;cursor:pointer}
#ui{
    position:fixed;top:10px;left:10px;
    padding:10px;background:rgba(0,0,0,.5);
    color:white;border-radius:6px;display:none;z-index:5;
}
#crosshair{
    position:fixed;top:50%;left:50%;
    width:18px;height:18px;margin:-9px;
    pointer-events:none;display:none;z-index:5;
}
#crosshair:before,#crosshair:after{
    content:'';position:absolute;background:white;
}
#crosshair:before{width:100%;height:2px;top:50%;transform:translateY(-50%)}
#crosshair:after{height:100%;width:2px;left:50%;transform:translateX(-50%)}
#msg{
    position:fixed;top:50%;left:50%;
    transform:translate(-50%,-50%);
    font-size:36px;color:yellow;display:none;z-index:20;
}
</style>
</head>
<body>

<div id="menu">
    <h1>SkyStrike：3D 槍戰</h1>
    <button onclick="startGame('easy')">簡單模式</button>
    <button onclick="startGame('normal')">普通模式</button>
    <button onclick="startGame('hard')">困難模式</button>
</div>

<div id="ui">HP：<span id="hp">5</span> | 擊殺數：<span id="kills">0</span></div>
<div id="crosshair"></div>
<div id="msg">通關成功！</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
/* ===== 模式設定 ===== */
const modes={
    easy:{spawn:2000,enemy:{color:0xff5555,speed:0.015,size:[0.9,1.8,0.6]},goal:20},
    normal:{spawn:1200,enemy:{color:0xff0000,speed:0.03,size:[0.6,1.6,0.4]},goal:40},
    hard:{spawn:700,enemy:{color:0xaa00ff,speed:0.055,size:[0.4,1.3,0.3]},goal:60}
};
let mode=null;

/* ===== 核心變數 ===== */
let scene,camera,renderer;
let player={pos:new THREE.Vector3()};
let bullets=[],enemies=[];
let keys={},yaw=0,pitch=0;
let hp=5;
let playing=false;
let kills=0;

/* ===== 初始化場景 ===== */
initScene();
animate();

/* ===== 開始遊戲 ===== */
function startGame(m){
    mode=modes[m];
    playing=true;
    kills=0;
    document.getElementById('kills').innerText=kills;
    document.getElementById('menu').style.display='none';
    document.getElementById('ui').style.display='block';
    document.getElementById('crosshair').style.display='block';
    document.getElementById('msg').style.display='none';
    bullets=[];
    enemies=[];
    player.pos.set(0,0,0);
    document.body.requestPointerLock();
    setInterval(spawnEnemy,mode.spawn);
}

/* ===== 場景 ===== */
function initScene(){
    scene=new THREE.Scene();
    scene.background=new THREE.Color(0x87ceeb);
    camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,1000);
    camera.rotation.order="YXZ";
    renderer=new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(innerWidth,innerHeight);
    document.body.appendChild(renderer.domElement);

    const floor=new THREE.Mesh(
        new THREE.PlaneGeometry(200,200),
        new THREE.MeshBasicMaterial({color:0x228B22})
    );
    floor.rotation.x=-Math.PI/2;
    scene.add(floor);
}

/* ===== 產生敵人 ===== */
function spawnEnemy(){
    if(!playing || !mode) return;
    const s=mode.enemy.size;
    const e=new THREE.Mesh(
        new THREE.BoxGeometry(s[0],s[1],s[2]),
        new THREE.MeshBasicMaterial({color:mode.enemy.color})
    );
    e.position.set((Math.random()-0.5)*40,0,-40);
    e.userData.speed=mode.enemy.speed;
    enemies.push(e);
    scene.add(e);
}

/* ===== 子彈 ===== */
function shoot(){
    if(!playing) return;
    const dir=new THREE.Vector3();
    camera.getWorldDirection(dir);
    const b=new THREE.Mesh(
        new THREE.SphereGeometry(0.06,6,6),
        new THREE.MeshBasicMaterial({color:0xffff00})
    );
    b.position.copy(camera.position);
    b.userData.vel=dir.clone().multiplyScalar(1);
    b.userData.life=80;
    bullets.push(b);
    scene.add(b);
}

/* ===== 輸入 ===== */
addEventListener("mousedown",e=>e.button===0&&shoot());
addEventListener("keydown",e=>keys[e.code]=true);
addEventListener("keyup",e=>keys[e.code]=false);
addEventListener("mousemove",e=>{
    if(!playing) return;
    yaw-=e.movementX*0.002;
    pitch-=e.movementY*0.002;
    pitch=Math.max(-1.4,Math.min(1.4,pitch));
});

/* ===== 主迴圈 ===== */
function animate(){
    requestAnimationFrame(animate);

    /* 移動 (W 前進) */
    const speed=0.12;
    const forward=new THREE.Vector3(Math.sin(yaw),0,Math.cos(yaw));
    const right=new THREE.Vector3(Math.sin(yaw+Math.PI/2),0,Math.cos(yaw+Math.PI/2));
    if(keys.KeyW) player.pos.add(forward.clone().multiplyScalar(speed));
    if(keys.KeyS) player.pos.add(forward.clone().multiplyScalar(-speed));
    if(keys.KeyA) player.pos.add(right.clone().multiplyScalar(-speed));
    if(keys.KeyD) player.pos.add(right.clone().multiplyScalar(speed));
    camera.position.copy(player.pos).add(new THREE.Vector3(0,1.6,0));
    camera.rotation.set(pitch,yaw,0);

    /* 子彈更新 & 碰到怪即擊殺 */
    bullets.forEach((b,bi)=>{
        b.position.add(b.userData.vel);
        b.userData.life--;

        enemies.forEach((e,ei)=>{
            const hitRadius = Math.max(
                e.geometry.parameters.width,
                e.geometry.parameters.height,
                e.geometry.parameters.depth
            )*0.5;

            if(b.position.distanceTo(e.position)<hitRadius){
                scene.remove(e);
                enemies.splice(ei,1);
                scene.remove(b);
                bullets.splice(bi,1);

                kills++;
                document.getElementById('kills').innerText=kills;

                // 通關判定
                if(kills>=mode.goal){
                    playing=false;
                    document.getElementById('msg').innerText='通關成功！';
                    document.getElementById('msg').style.display='block';
                }
            }
        });

        if(b.userData.life<=0){
            scene.remove(b);
            bullets.splice(bi,1);
        }
    });

    /* 敵人追逐 */
    enemies.forEach(e=>{
        const d=new THREE.Vector3().subVectors(player.pos,e.position).normalize();
        e.position.add(d.multiplyScalar(e.userData.speed));
    });

    renderer.render(scene,camera);
}

/* ===== 視窗調整 ===== */
addEventListener("resize",()=>{
    camera.aspect=innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
